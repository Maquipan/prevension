<script>
    // --- FUNCIÓN PARA CARGAR CONTENIDO DE PESTAÑAS ---
    async function loadTabContent(btn, tabName) {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.classList.remove('active'));
        btn.classList.add('active');
        const contentArea = document.getElementById('tab-content-area');
        const registroBox = document.getElementById('registro-actividad-box');
        contentArea.innerHTML = '<p>Cargando contenido...</p>';
        try {
            const response = await fetch(`capacitaciones/${tabName}.html`);
            if (!response.ok) throw new Error(`Error al cargar`);
            contentArea.innerHTML = await response.text();
            
            if (tabName === 'informe-riesgos') {
                registroBox.style.display = 'none';
                const firmaCanvas = document.getElementById('firma_trabajador_irl');
                if (firmaCanvas) initializeSignaturePad(firmaCanvas);
            } else {
                registroBox.style.display = 'block';
                const temasTextarea = document.getElementById('temasTratados');
                const temasSource = contentArea.querySelector('.temas-para-registro');
                if (temasSource && temasTextarea) {
                    temasTextarea.value = temasSource.textContent.trim();
                    localStorage.setItem('temasTratados', temasTextarea.value);
                } else if(temasTextarea) {
                    temasTextarea.value = 'Temas no especificados.';
                    localStorage.setItem('temasTratados', temasTextarea.value);
                }
            }
        } catch (error) {
            console.error('Error al cargar la pestaña:', error);
            contentArea.innerHTML = `<p style="color: red;">Error: No se encontró el material.</p>`;
        }
    }

    // --- FUNCIÓN DE DESCARGA PDF (MÉTODO DE IMPRESIÓN) ---
    function descargarInformeComoPdf() {
        alert("Se abrirá el diálogo de impresión. Por favor, selecciona 'Guardar como PDF' como destino.");
        window.print();
    }

    // --- FUNCIÓN DE DESCARGA WORD (MÉTODO DIRECTO) ---
    function descargarInformeComoWord() {
        const formElement = document.getElementById('form-irl-container');
        if (!formElement) return alert('Contenedor del formulario no encontrado.');

        const formClone = formElement.cloneNode(true);

        formClone.querySelectorAll('input[type="text"]').forEach(input => {
            const valueSpan = document.createElement('span');
            valueSpan.innerHTML = `<strong>${input.value || '__________'}</strong>`;
            input.parentNode.replaceChild(valueSpan, input);
        });
        const canvas = document.getElementById('firma_trabajador_irl');
        const canvasClone = formClone.querySelector('#firma_trabajador_irl');
        if (canvas && canvasClone) {
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.style.width = '250px';
            canvasClone.parentNode.replaceChild(img, canvasClone);
        }
        formClone.querySelectorAll('.download-buttons-container').forEach(b => b.remove());
        const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body { font-family: Arial, sans-serif; font-size: 11px; } table { border-collapse: collapse; width: 100%; page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; } td, th { border: 1px solid black; padding: 5px; } .form-irl-section-title { background-color: #0070c0; color: white; font-weight: bold; padding: 8px; font-size: 12px; } .title-cell-irl { font-size: 14px; font-weight: bold; text-align: center; }</style></head><body>${formClone.innerHTML}</body></html>`;
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(htmlContent);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = 'Informe_Riesgos_Editable.doc';
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }
    
    // --- FUNCIÓN DE DESCARGA PNG (PARA INFORME DE RIESGOS) ---
    async function descargarInformeRiesgos() {
        const formElement = document.getElementById('form-irl-container');
        if (!formElement) return alert('Contenedor del formulario no encontrado.');
        alert('Preparando descarga PNG...');
        html2canvas(formElement, { scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Informacion_Riesgos_Laborales.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    // --- FUNCIÓN DE DESCARGA PNG PARA REGISTRO DE ACTIVIDAD (CORREGIDA) ---
    async function descargarComoPng() {
        const formElement = document.getElementById('registroActividadForm');
        const textarea = document.getElementById('temasTratados');
        if (!formElement || !textarea) return alert("No se encontró el formulario de registro.");

        const div = document.createElement('div');
        const computedStyle = window.getComputedStyle(textarea);
        
        // Copiamos manualmente los estilos necesarios para evitar el error
        div.style.width = computedStyle.width;
        div.style.height = computedStyle.height;
        div.style.padding = computedStyle.padding;
        div.style.border = computedStyle.border;
        div.style.fontFamily = computedStyle.fontFamily;
        div.style.fontSize = computedStyle.fontSize;
        div.style.lineHeight = computedStyle.lineHeight;
        div.style.color = computedStyle.color;
        div.style.backgroundColor = computedStyle.backgroundColor;
        div.style.boxSizing = 'border-box';
        div.style.whiteSpace = 'pre-wrap';
        div.style.wordWrap = 'break-word';
        div.innerHTML = textarea.value.replace(/\n/g, '<br>');

        // Reemplazamos temporalmente el textarea con el div
        textarea.style.display = 'none';
        textarea.parentElement.appendChild(div);

        await new Promise(r => setTimeout(r, 100)); // Pequeña pausa para asegurar la renderización

        try {
            const canvas = await html2canvas(formElement, { scale: 2, backgroundColor: '#fff', useCORS: true });
            const link = document.createElement('a');
            link.download = 'Registro_Actividad.png';
            link.href = canvas.toDataURL();
            link.click();
        } catch (error) {
            console.error("Error al generar el PNG:", error);
            alert("Ocurrió un error al generar la imagen.");
        } finally {
            // Nos aseguramos de restaurar el textarea original, incluso si hay un error
            textarea.parentElement.removeChild(div);
            textarea.style.display = 'block';
        }
    }

    // --- FUNCIONES DE FIRMA Y FORMULARIO (SIN CAMBIOS) ---
    function initializeSignaturePad(canvasEl) {
        if (!canvasEl) return;
        const ctx = canvasEl.getContext('2d');
        let drawing = false;
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const rect = canvasEl.getBoundingClientRect();
            canvasEl.width = rect.width * ratio; canvasEl.height = rect.height * ratio;
            canvasEl.getContext('2d').scale(ratio, ratio);
            loadSignature(canvasEl.id);
        }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        function getPos(e) {
            const r = canvasEl.getBoundingClientRect();
            const cX = e.touches ? e.touches[0].clientX : e.clientX;
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cX - r.left, y: cY - r.top };
        }
        function start(e) { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
        function end(e) { if (!drawing) return; e.preventDefault(); drawing = false; ctx.beginPath(); saveSignature(canvasEl.id, canvasEl.toDataURL()); }
        function draw(e) { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineWidth = 2.5; ctx.lineCap = 'round'; ctx.strokeStyle = '#333'; ctx.lineTo(p.x, p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
        canvasEl.addEventListener('mousedown', start); canvasEl.addEventListener('mouseup', end); canvasEl.addEventListener('mousemove', draw);
        canvasEl.addEventListener('touchstart', start, { passive: false }); canvasEl.addEventListener('touchend', end, { passive: false }); canvasEl.addEventListener('touchmove', draw, { passive: false });
    }
    function saveSignature(id, data) { localStorage.setItem(id, data); }
    function loadSignature(id) {
        const data = localStorage.getItem(id);
        const canvas = document.getElementById(id);
        if (data && canvas) {
            const img = new Image();
            img.onload = () => { canvas.getContext('2d').drawImage(img, 0, 0, canvas.getBoundingClientRect().width, canvas.getBoundingClientRect().height); };
            img.src = data;
        }
    }
    function clearSignature(id) {
        const c = document.getElementById(id); if(c) { c.getContext('2d').clearRect(0, 0, c.width, c.height); localStorage.removeItem(id); }
    }
    function limpiarFormulario() {
        if (confirm('¿Estás seguro? Esta acción no se puede deshacer.')) {
            let keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('p_') || ['relatorSignaturePad', 'fecha', 'horaInicio', 'horaTermino', 'temasTratados', 'relatorEncargado', 'charla', 'reunion', 'inspeccion', 'induccion', 'capacitacion', 'auditoria'].includes(key)) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            window.location.reload();
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const defaultValues = { 'fecha': new Date().toISOString().split('T')[0], 'capacitacion': true, 'horaInicio': '09:00', 'horaTermino': '10:00', 'relatorEncargado': 'Oscar Cayuqueo' };
        document.querySelectorAll('input, textarea').forEach(input => {
            if (input.id) {
                const saved = localStorage.getItem(input.id);
                if (saved) { input.type === 'checkbox' ? input.checked = saved === 'true' : input.value = saved; }
                else if (defaultValues[input.id]) { input.type === 'checkbox' ? input.checked = defaultValues[input.id] : input.value = defaultValues[input.id]; }
                input.addEventListener('input', () => { localStorage.setItem(input.id, input.type === 'checkbox' ? input.checked : input.value); });
            }
        });
        const pTable = document.getElementById('participantesTable');
        if (pTable) {
            const tBody = pTable.getElementsByTagName('tbody')[0];
            for (let i = 1; i <= 6; i++) {
                const row = tBody.insertRow();
                row.innerHTML = `<td data-label="N°">${i}</td><td data-label="RUT"><input type="text" id="p_rut_${i}"></td><td data-label="NOMBRE"><input type="text" id="p_name_${i}"></td><td data-label="CARGO"><input type="text" id="p_cargo_${i}"></td><td data-label="FIRMA"><canvas id="p_sig_${i}" class="participant-signature-pad"></canvas></td>`;
                ['rut', 'name', 'cargo'].forEach(t => {
                    const el = document.getElementById(`p_${t}_${i}`);
                    const val = localStorage.getItem(el.id);
                    if(val) el.value = val;
                    el.addEventListener('input', () => localStorage.setItem(el.id, el.value));
                });
            }
        }
        document.querySelectorAll('.participant-signature-pad').forEach(c => { 
            if(c) initializeSignaturePad(c); 
        });
        const firstTab = document.querySelector('.tab-button');
        if (firstTab) firstTab.click();
    });
</script>
