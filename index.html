<script>
    // --- FUNCIÓN PARA CARGAR CONTENIDO DE PESTAÑAS Y ACTUALIZAR EL FORMULARIO ---
    async function loadTabContent(btn, tabName) {
        // Marcar el botón presionado como activo
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.classList.remove('active'));
        btn.classList.add('active');

        const contentArea = document.getElementById('tab-content-area');
        const temasTextarea = document.getElementById('temasTratados');
        contentArea.innerHTML = '<p>Cargando contenido...</p>';

        try {
            // Cargar el archivo HTML correspondiente
            const response = await fetch(`capacitaciones/${tabName}.html`);
            if (!response.ok) throw new Error(`No se pudo cargar la capacitación: ${response.statusText}`);
            
            const htmlContent = await response.text();
            contentArea.innerHTML = htmlContent;

            // --- ¡NUEVA LÓGICA! ---
            // Buscar el div oculto con los temas dentro del contenido recién cargado
            const temasSource = contentArea.querySelector('.temas-para-registro');
            if (temasSource) {
                // Si se encuentra, actualizar el valor del textarea
                temasTextarea.value = temasSource.textContent.trim();
                // Guardar automáticamente el cambio en localStorage
                localStorage.setItem('temasTratados', temasTextarea.value);
            } else {
                // Si no se encuentra, limpiar el campo
                temasTextarea.value = 'Temas no especificados para este curso.';
                localStorage.setItem('temasTratados', temasTextarea.value);
            }

        } catch (error) {
            console.error('Error al cargar la pestaña:', error);
            contentArea.innerHTML = `<p style="color: red;">Error: No se encontró el material de la capacitación '${tabName}'.</p>`;
        }
    }


    function initializeSignaturePad(canvasEl) {
        const ctx = canvasEl.getContext('2d');
        let drawing = false;

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const rect = canvasEl.getBoundingClientRect();
            canvasEl.width = rect.width * ratio;
            canvasEl.height = rect.height * ratio;
            canvasEl.getContext('2d').scale(ratio, ratio);
            loadSignature(canvasEl.id);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getPos(event) {
            const rect = canvasEl.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches) {
                if (event.touches.length === 0) return;
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function stopDrawing(e) {
            if (!drawing) return;
            e.preventDefault();
            drawing = false;
            ctx.beginPath();
            saveSignature(canvasEl.id, canvasEl.toDataURL());
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#333';
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        canvasEl.addEventListener('mousedown', startDrawing);
        canvasEl.addEventListener('mouseup', stopDrawing);
        canvasEl.addEventListener('mousemove', draw);
        canvasEl.addEventListener('mouseout', stopDrawing);
        canvasEl.addEventListener('touchstart', startDrawing, { passive: false });
        canvasEl.addEventListener('touchend', stopDrawing, { passive: false });
        canvasEl.addEventListener('touchmove', draw, { passive: false });
    }

    function saveSignature(id, data) { localStorage.setItem(id, data); }

    function loadSignature(id) {
        const dataURL = localStorage.getItem(id);
        const canvas = document.getElementById(id);
        if (dataURL && canvas) {
            const img = new Image();
            img.onload = function() {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.getBoundingClientRect().width, canvas.getBoundingClientRect().height);
            };
            img.src = dataURL;
        }
    }
    
    function clearSignature(canvasId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        localStorage.removeItem(canvasId);
    }
    
    function limpiarFormulario() {
        if (confirm('¿Estás seguro de que quieres borrar todos los datos del formulario? Esta acción no se puede deshacer.')) {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                 if (key.startsWith('participant_') || key.includes('Signature') || ['fecha', 'horaInicio', 'horaTermino', 'temasTratados', 'relatorEncargado', 'charla', 'reunion', 'inspeccion', 'induccion', 'capacitacion', 'auditoria'].includes(key)) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            window.location.reload();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- VALORES POR DEFECTO ACTUALIZADOS ---
        // Se quitó 'temasTratados' de aquí, ya que se cargará dinámicamente
        const defaultValues = {
            'fecha': new Date().toISOString().split('T')[0], // Pone la fecha actual por defecto
            'capacitacion': true,
            'horaInicio': '09:00',
            'horaTermino': '10:00',
            'relatorEncargado': 'Oscar Cayuqueo'
        };

        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            if (input.id) {
                // No aplicar valores por defecto a 'temasTratados', dejar que la función de pestañas lo controle
                if(input.id === 'temasTratados') {
                    const savedValue = localStorage.getItem(input.id);
                    if(savedValue) input.value = savedValue;
                } else {
                    const savedValue = localStorage.getItem(input.id);
                    if (savedValue !== null) { 
                        if (input.type === 'checkbox') input.checked = savedValue === 'true';
                        else input.value = savedValue;
                    } else if (defaultValues[input.id] !== undefined) {
                         if (input.type === 'checkbox') input.checked = defaultValues[input.id];
                         else input.value = defaultValues[input.id];
                    }
                }
                
                input.addEventListener('input', () => {
                    const value = input.type === 'checkbox' ? input.checked : input.value;
                    localStorage.setItem(input.id, value);
                });
            }
        });
        
        const tableBody = document.getElementById('participantesTable').getElementsByTagName('tbody')[0];
        const numParticipants = 6;
        for (let i = 1; i <= numParticipants; i++) {
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `<td data-label="N°" style="text-align: center;">${i}</td>
                                <td data-label="RUT"><input type="text" id="participant_rut_${i}"></td>
                                <td data-label="NOMBRE Y APELLIDO"><input type="text" id="participant_name_${i}"></td>
                                <td data-label="CARGO"><input type="text" id="participant_cargo_${i}"></td>
                                <td data-label="FIRMA"><canvas id="participantSignature${i}" class="participant-signature-pad"></canvas></td>`;
            
             ['rut', 'name', 'cargo'].forEach(type => {
                const inputId = `participant_${type}_${i}`;
                const inputEl = document.getElementById(inputId);
                const savedValue = localStorage.getItem(inputId);
                if (savedValue) inputEl.value = savedValue;
                inputEl.addEventListener('input', () => localStorage.setItem(inputId, inputEl.value));
            });
        }
        
        const allCanvases = document.querySelectorAll('.signature-pad, .participant-signature-pad');
        allCanvases.forEach(canvas => {
            if (canvas) initializeSignaturePad(canvas);
        });

        // Cargar la primera pestaña por defecto al iniciar la página
        // Esto también llenará el campo "Temas Tratados" por primera vez
        const firstTab = document.querySelector('.tab-button');
        if (firstTab) {
            firstTab.click();
        }
    });
    
    async function descargarComoPng() {
        const formElement = document.getElementById('registroActividadForm');
        const temasTextarea = document.getElementById('temasTratados');
        const containerOfTextarea = temasTextarea.parentElement;
        const replacementDiv = document.createElement('div');
        const styles = window.getComputedStyle(temasTextarea);
        ['width', 'height', 'padding', 'border', 'borderRadius', 'fontFamily', 'fontSize', 'lineHeight', 'color', 'boxSizing'].forEach(prop => {
            replacementDiv.style[prop] = styles[prop];
        });
        replacementDiv.style.whiteSpace = 'pre-wrap';
        replacementDiv.style.wordWrap = 'break-word';
        replacementDiv.style.minHeight = '100px'; // Asegura una altura mínima
        replacementDiv.innerHTML = temasTextarea.value.replace(/\n/g, '<br>'); // Reemplaza saltos de línea
        temasTextarea.style.display = 'none';
        containerOfTextarea.appendChild(replacementDiv);

        await new Promise(resolve => setTimeout(resolve, 100));

        html2canvas(formElement, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            windowWidth: formElement.scrollWidth,
            windowHeight: formElement.scrollHeight
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Registro_Actividad_Maquipan.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            containerOfTextarea.removeChild(replacementDiv);
            temasTextarea.style.display = 'block';
        }).catch(err => {
            console.error('Error al generar la imagen:', err);
            containerOfTextarea.removeChild(replacementDiv);
            temasTextarea.style.display = 'block';
        });
    }
</script>
